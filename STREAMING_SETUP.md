# LiveKit Streaming Setup

This project uses LiveKit for real-time video and chat integration.

## Prerequisites

1.  **LiveKit Project**: Sign up at [LiveKit Cloud](https://livekit.io/cloud) or host your own.
2.  **API Credentials**: Get your `API URL`, `API Key`, and `API Secret`.

## Environment Variables

Add the following to your `.env.local` file:

\`\`\`bash
NEXT_PUBLIC_LIVEKIT_URL=wss://your-project.livekit.cloud
LIVEKIT_API_KEY=your_api_key
LIVEKIT_API_SECRET=your_api_secret
\`\`\`

## How it works

1.  **Token Generation**: The backend (`/api/livekit/token`) generates access tokens for users to join a room.
2.  **Iframe Integration**: The video player is embedded via an iframe (`/iframe/live`) which connects to LiveKit using the token.
3.  **Video & Chat**: The iframe handles both video rendering and chat messaging using LiveKit's data channels.

## Testing

1.  Start the development server.
2.  Go to a show page.
3.  The iframe should load and attempt to connect to the LiveKit room corresponding to the show ID.

## Architecture

### Client-Side Playback
- **Format:** WebRTC via LiveKit SDK
- **Integration:** Iframe embed (`/iframe/live`)
- **Chat:** Real-time data channels within the same connection

### Broadcasting
- **Protocol:** WebRTC
- **Endpoint:** LiveKit Server (Cloud or Self-hosted)
- **Authentication:** JWT Tokens generated by backend

### API Endpoints

#### Initialize Stream
\`\`\`
POST /api/streams/initialize
Body: { showId, hostName }
Response: { streamId }
\`\`\`

#### Get LiveKit Token
\`\`\`
GET /api/livekit/token?room={roomName}&username={username}
Response: { token }
\`\`\`

## Troubleshooting

### No Video Stream Appearing
- Verify LiveKit Server URL is correct in `.env.local`
- Check if the room exists or is being created dynamically
- Ensure firewall allows WebRTC traffic (UDP ports)

### Connection Issues
- Check browser console for LiveKit connection errors
- Verify API Key and Secret are correct
- Ensure token generation is working correctly

## Security Considerations

1. **API Key Protection:**
   - Never expose `LIVEKIT_API_KEY` or `LIVEKIT_API_SECRET` in client code
   - Use environment variables
   - Only expose `NEXT_PUBLIC_LIVEKIT_URL` to the client

2. **Token Management:**
   - Tokens are generated server-side
   - Tokens have expiration times and specific permissions (publish/subscribe)

## Additional Resources

- [LiveKit Documentation](https://docs.livekit.io/)
- [LiveKit GitHub](https://github.com/livekit)
